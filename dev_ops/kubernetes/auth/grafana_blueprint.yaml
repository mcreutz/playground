apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-setup-blueprint
  namespace: authentik
data:
  blueprint.yaml: |
    version: 1
    entries:
      # Groups scope mapping â€” returns user's group names in the token
      - model: authentik_providers_oauth2.scopemapping
        id: grafana-groups-scope
        identifiers:
          managed: grafana-groups-scope
        attrs:
          name: "Grafana Groups"
          scope_name: groups
          expression: |
            return {"groups": [group.name for group in request.user.ak_groups.all()]}

      # Authentik groups that map to Grafana roles
      - model: authentik_core.group
        id: grafana-admins
        identifiers:
          name: Grafana Admins

      - model: authentik_core.group
        id: grafana-editors
        identifiers:
          name: Grafana Editors

      # OAuth2 provider
      - model: authentik_providers_oauth2.oauth2provider
        id: grafana-provider
        identifiers:
          name: Grafana
        attrs:
          client_id: "grafana"
          client_secret: "my-reproducible-secret-12345"
          authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]
          property_mappings:
            - !Find [authentik_core.propertymapping, [managed, "goauthentik.io/providers/oauth2/scope-email"]]
            - !Find [authentik_core.propertymapping, [managed, "goauthentik.io/providers/oauth2/scope-openid"]]
            - !Find [authentik_core.propertymapping, [managed, "goauthentik.io/providers/oauth2/scope-profile"]]
            - !KeyOf grafana-groups-scope
          redirect_uris:
            - matching_mode: strict
              url: https://grafana2.server03.creutz.io/login/generic_oauth

      # Application
      - model: authentik_core.application
        id: grafana-app
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !KeyOf grafana-provider
